#Run blogpost-checker in a Docker container to validate the new blogpost
name: validate-blogpost

on:
  pull_request:
    branches:
      - master

jobs:
  pull-and-run-blogpost-checker-image:
    runs-on: ubuntu-latest

    steps:
      - name: Inject env
        uses: rlespinasse/github-slug-action@v3.x
  
      - uses: actions/checkout@v2
        
      - name: find
        run: find /home/runner/work -name '*.md' 
      
      - name: git log
        run: |
          CURRENT_COMMIT=`cd /home/runner/work/devblog/devblog && git log | sed -e 's/\"Merge\s\(.*\)into\(.*\)/\1/'`
          echo $CURRENT_COMMIT
          export $CURRENT_COMMIT
          echo "::set-env name=CURRENT_COMMIT::$CURRENT_COMMIT"
          echo $CURRENT_COMMIT
        
      - name: print env
        run: printenv | sort
      
      - name: Test
        run: echo ${{ env.CURRENT_COMMIT }}
      
      - uses: actions/checkout@v2
        with:
          repository: ${{ env.GITHUB_REPOSITORY_OWNER_PART }}/${{ env.GITHUB_REPOSITORY_NAME_PART }}
          ref: ${{ env.CURRENT_COMMIT }}

      - name: find
        run: find /home/runner/work/devblog -name '*.md'

      - name: Pull Docker image
        run: docker pull jekyll2cms/blogpost-checker:1.0.0

      - name: Run Docker image
        run: docker run --env REPOSITORY_REMOTE_URL='https://github.com/${{ env.GITHUB_REPOSITORY_OWNER_PART }}/${{ env.GITHUB_REPOSITORY_NAME_PART }}' --env REPOSITORY_BRANCH_NAME='${{ env.GITHUB_HEAD_REF_SLUG }}' jekyll2cms/blogpost-checker:1.0.0
